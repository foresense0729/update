# 技術架構提案：RAGFlow 整合轉型方案評估 (v2.0)

> **致：** 技術開發團隊 / Tech Lead
> **狀態：** 草案 (Draft) - 供架構決策參考
> **核心議題：** 解決聊天室「對話紀錄無法保存」之痛點，並評估不同深度的整合方案。

---

## 1. 問題詳述 (Problem Description)

目前的聊天室實作採用 **Iframe 嵌入模式** (指向 RAGFlow 的公開分享連結)。經過實際測試與使用者反饋，此模式存在以下結構性問題：

### 1.1 狀態遺失 (Statelessness)
RAGFlow 的分享連結 (Shared Link) 設計初衷是為了「快速分享」，並非為了「長期服務」。
- 當使用者 **重新整理網頁**、**關閉分頁再打開** 或 **切換裝置** 時，Iframe 內的 Session 會被重置。
- 使用者會發現「歷史對話全部消失」，這對於連續性的諮詢服務 (如法律諮詢、客服) 是致命的體驗缺陷。

### 1.2 數據孤島 (Data Silo)
- 對話紀錄儲存在使用者的 LocalStorage (如果是 Client-side) 或 RAGFlow 的匿名 Session 中。
- 我們的 **會員資料庫 (Neon DB)** 與 **對話紀錄** 是脫鉤的。我們無法分析特定會員的提問傾向，也無法提供「查看上週諮詢紀錄」的功能。

### 1.3 介面限制 (UI Limitations)
- Iframe 是一個黑盒子，我們無法客製化內部的字體、顏色或載入動畫，導致產品視覺體驗不一致。

---

## 2. 改善目標 (The Goal)

我們需要將架構從「嵌入式」轉型為 **「API 整合式」**。
目標是達成：
1.  **帳號綁定**：使用者登入後，無論何時何地，都能看到自己過往的對話。
2.  **數據自主**：將對話數據的所有權收回，或至少建立與 User ID 的連結。
3.  **體驗升級**：使用我們自己的 React 前端組件，提供流暢的原生體驗。

---

## 3. 實作方案選項 (Implementation Options)

針對上述目標，提出三種不同整合深度的方案，請根據開發資源與控制需求進行選擇。

### 方案 A：對話 ID 映射 (Session Mapping Proxy) —— *推薦 MVP*
這是一個「輕量級」的解決方案。我們不儲存具體對話內容，只儲存「索引」。

*   **機制**：
    *   在我們的資料庫建立一張對照表：`Table(UserID, RagflowConversationID)`。
    *   當使用者開啟聊天室，後端先查表。
        *   若有 ID -> 呼叫 RAGFlow API 繼續該對話 (Resume)。
        *   若無 ID -> 呼叫 RAGFlow API 開新對話 (New) 並存入 ID。
    *   具體訊息內容仍由 RAGFlow 託管。
*   **優點**：
    *   **開發快**：後端只需維護一個 ID Mapping。
    *   **成本低**：不佔用大量資料庫空間。
*   **缺點**：
    *   若 RAGFlow 資料庫重置，歷史紀錄仍會遺失。
    *   較難進行細緻的「對話內容搜尋/分析」(因為資料不在我們手上)。

### 方案 B：全量訊息託管 (Full Message Stewardship) —— *推薦長期架構*
這是一個「控制權最大」的解決方案。我們將 RAGFlow 視為純粹的計算引擎 (Inference Engine)。

*   **機制**：
    *   **所有** 的對話紀錄 (User Query + AI Answer) 都直接寫入 **我們的 Neon 資料庫**。
    *   當使用者發言時，我們的後端撈出「最近 N 則歷史訊息」，組裝成 Prompt Context，一次性發送給 RAGFlow (Stateless Request)。
*   **優點**：
    *   **數據完全自主**：即使換掉 RAGFlow 改用 OpenAI 或 Claude，使用者的歷史紀錄依然存在我們家。
    *   **分析能力強**：可直接對資料庫進行 SQL 查詢分析用戶行為。
*   **缺點**：
    *   **開發成本高**：需自行處理 Context Window (上下文長度) 的裁切與管理。
    *   **儲存成本**：需規劃訊息儲存的資料結構。

### 方案 C：前端直連 (Client-Side Direct) —— *僅供參考*
讓前端 React 直接呼叫 RAGFlow API。

*   **機制**：
    *   瀏覽器直接發送 HTTP Request 給 RAGFlow。
*   **風險警告**：
    *   **安全性極低**：除非 RAGFlow 支援 User-Level Token，否則必須將 Admin/API Key 暴露在前端程式碼中，極易被盜用。
    *   **不建議採用**，除非是內部網域且受信任的環境。

---

## 4. 建議做法 (Recommendation)

考量到目前的開發進度與架構複雜度，建議採取 **漸進式策略**：

1.  **第一階段 (Phase 1)**：採用 **方案 A (Session Mapping)**。
    *   理由：改動最小，能最快解決「無法保存紀錄」的燃眉之急。只需在現有 User Table 增加一個欄位即可。
    
2.  **第二階段 (Phase 2)**：視需求遷移至 **方案 B**。
    *   理由：若未來需要更深入的用戶行為分析，或需要切換不同的 AI 引擎時，再將歷史訊息拉回自己家管理。

此提案保留了實作彈性，請技術團隊根據當前的時程壓力與長期維護規劃進行最終決策。

---
*文件產生日期: 2026/01/16*
